<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <title>Loca√ß√£o de Livros</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
</head>

<body>
    <!--Navbar-->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#">Fatec Library</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="#">
                            <i class="bi bi-house"></i> In√≠cio</a></li>
                    <li class="nav-item"><a class="nav-link" href="locacao.html"><i class="bi bi-book"></i>
                            Loca√ß√£o de Livros</a></li>
                    <li class="nav-item"><a class="nav-link" href="usuarios.html"><i class="bi bi-people"></i>
                            Usu√°rios</a></li>
                    <li class="nav-item"><a class="nav-link" href="relatorios.html"><i class="bi bi-newspaper"></i>
                            Relat√≥rios</a></li>
                    <li class="nav-item">
                        <button class="btn btn-danger" onclick="logout()">
                            <i class="bi bi-box-arrow-right"></i> Sair</button>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container py-5">
        <h2 class="mb-4">Meus Livros</h2>
        <div class="card mb-4">
            <div class="card-body">
                <form id="form-locacao">
                    <input type="hidden" id="id-edicao" />
                    <div class="mb-3">
                        <label for="titulo" class="form-label">T√≠tulo do Livro</label>
                        <input type="text" id="titulo" class="form-control" placeholder="Informe o t√≠tulo do livro" required />
                    </div>
                    <div class="mb-3">
                        <label for="autor" class="form-label">Autor</label>
                        <input type="text" id="autor" class="form-control" placeholder="Informe o autor do livro" required />
                    </div>
                    <div class="mb-3">
                        <label for="genero" class="form-label">Categoria</label>
                        <select id="genero" class="form-select" required>
                            <option value="">Selecione...</option>
                            <option value="Romance">üåπ Romance</option>
                            <option value="Fic√ß√£o">üéÉ Fic√ß√£o</option>
                            <option value="Estudo">üìö Estudo</option>
                            <option value="Outros">üìÉ Outros</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="data_locacao" class="form-label">Data de Loca√ß√£o</label>
                        <input type="date" id="data_locacao" class="form-control" required />
                    </div>
                    <div class="mb-3">
                        <label for="data_devolucao" class="form-label">Data de Devolu√ß√£o</label>
                        <input type="date" id="data_devolucao" class="form-control" required />
                    </div>
                    <button type="submit" class="btn btn-primary">Salvar Livro</button>
                    <button type="button" id="cancelar-edicao" class="btn btn-secondary d-none">Cancelar</button>
                </form>
            </div>
        </div>
        <ul class="list-group" id="lista-locacoes"></ul>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        const urlSupabase = 'https://leifjrmtmaflyaocpbin.supabase.co';
        const anon = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxlaWZqcm10bWFmbHlhb2NwYmluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcxNzUyMTUsImV4cCI6MjA2Mjc1MTIxNX0.ALEM4vwgTKsUwy2EyJQBs3dlSJK0DqKXEGofeljSeZ4';

        const supabase = createClient(urlSupabase, anon);

        const session = JSON.parse(localStorage.getItem('session'));
        if (!session) window.location.href = 'index.html';

        const user_id = session.user.id;
        const lista = document.getElementById('lista-locacoes');

        async function carregarLocacoes() {
            const { data, error } = await supabase
                .from('locacoes')
                .select('*')
                .eq('user_id', user_id)
                .order('data_devolucao', { ascending: false });

            lista.innerHTML = '';

            if (data) {
                data.forEach(l => {
                    const item = document.createElement('li');
                    item.className = 'list-group-item d-flex justify-content-between align-items-center';

                    const texto = document.createElement('span');
                    texto.textContent = `${l.titulo} - ${l.autor} - Locado em: ${formatarDataBr(l.data_locacao)} - Devolu√ß√£o: ${formatarDataBr(l.data_devolucao)}`;

                    const botoes = document.createElement('div');
                    botoes.innerHTML = `
                        <button class="btn btn-sm btn-light me-2 editar" data-id="${l.id}">‚úèÔ∏è</button>
                        <button class="btn btn-sm btn-dark excluir" data-id="${l.id}">üóëÔ∏è</button>
                    `;

                    item.appendChild(texto);
                    item.appendChild(botoes);
                    lista.appendChild(item);
                });

                document.querySelectorAll('.editar').forEach(btn => {
                    btn.addEventListener('click', () => editarLocacao(btn.dataset.id));
                });

                document.querySelectorAll('.excluir').forEach(btn => {
                    btn.addEventListener('click', () => excluirLocacao(btn.dataset.id));
                });
            }
        }

        document.getElementById('form-locacao').addEventListener('submit', async (e) => {
            e.preventDefault();

            const id = document.getElementById('id-edicao').value;

            const novaLocacao = {
                user_id,
                titulo: titulo.value,
                autor: autor.value,
                data_locacao: data_locacao.value,
                data_devolucao: data_devolucao.value,
            };

            if (id) {
                await supabase.from('locacoes').update(novaLocacao).eq('id', id);
                mostrarMensagem('success', 'Loca√ß√£o atualizada com sucesso!');
            } else {
                await supabase.from('locacoes').insert(novaLocacao);
                mostrarMensagem('success', 'Loca√ß√£o cadastrada com sucesso!');
            }

            limparFormulario();
            await carregarLocacoes();
        });

        function limparFormulario() {
            document.getElementById('form-locacao').reset();
            document.getElementById('id-edicao').value = '';
            document.getElementById('cancelar-edicao').classList.add('d-none');
        }

        async function editarLocacao(id) {
            const { data } = await supabase.from('locacoes').select('*').eq('id', id).single();
            if (data) {
                titulo.value = data.titulo;
                autor.value = data.autor;
                data_locacao.value = data.data_locacao;
                data_devolucao.value = data.data_devolucao;
                document.getElementById('id-edicao').value = data.id;
                document.getElementById('cancelar-edicao').classList.remove('d-none');
            }
        }

        async function excluirLocacao(id) {
            if (confirm('Tem certeza que deseja excluir esta loca√ß√£o?')) {
                const { error } = await supabase.from('locacoes').delete().eq('id', id);
                if (!error) {
                    mostrarMensagem('success', 'Loca√ß√£o exclu√≠da com sucesso!');
                } else {
                    mostrarMensagem('danger', 'Erro ao excluir a loca√ß√£o.');
                }
                await carregarLocacoes();
            }
        }

        document.getElementById('cancelar-edicao').addEventListener('click', () => {
            limparFormulario();
        });

        carregarLocacoes();

        function formatarDataBr(dataISO) {
            if (!dataISO) return 'N√£o Informado';
            const [ano, mes, dia] = dataISO.split('-');
            return `${dia}/${mes}/${ano}`;
        }

        window.logout = async function () {
            await supabase.auth.signOut();
            localStorage.removeItem('session');
            window.location.href = 'index.html';
        }

        function mostrarMensagem(tipo, texto) {
            const mensagem = document.createElement('div');
            mensagem.className = `alert alert-${tipo}`;
            mensagem.textContent = texto;
            document.body.prepend(mensagem);
            setTimeout(() => mensagem.remove(), 3000);
        }
    </script>
</body>

</html>